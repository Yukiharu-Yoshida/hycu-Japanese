.. _protectingapps:

-----------------------------------
HYCU: アプリケーションの保護（SQL）
-----------------------------------

*この演習の推定所要時間は60分です。*

概要
++++++++
HYCUには、仮想マシンでのエージェント展開やメンテナンスを必要とせずにアプリケーションを保護する非常にユニークな機能があります。また、仮想マシン上で実行されているアプリケーションを検出し、アプリケーション整合性を維持した最も適切な方法でそれらを保護します。これにより、仮想マシンのバックアップに多くの構成手順を必要とすることなく、顧客はアプリケーションに集中できます。この演習ではSQL Serverを使用しますが、他のアプリケーションのバックアップと復元にも同じ仕組みが使用されます。

資格情報の割り当て
=====================

#. SQL ServerがインストールされているVMを選択し、HYCU UIの右上隅にある *Credentials*（資格情報）をクリックします。

#. 資格情報画面が表示されたら、SQLサーバーの資格情報（ *+New*を使用）を追加します。資格情報にはVMに対するsysadmin権限が必要です。

#. 認証情報を入力したら、 *Assign*をクリックして資格情報をVMに割り当て、検出プロセスを開始します。

   .. figure:: images/1.png

#. 資格情報を割り当てると、検出が自動的に起動されることに注意してください。検出はWindowsではWinRM、Linux VMではSSHを使用します。

   .. figure:: images/2.png

   .. figure:: images/3.png

#. ほとんどの場合、マシンの初期設定に基づいて、追加の手順を必要とせずに検出が成功します。失敗した場合は、`こちらのKB <https://support.hycu.com/hc/en-us/articles/115003880025-Troubleshooting-Application-discovery-failed-Windows->`_を使用してトラブルシューティングするのが最も簡単です。

#. 検出完了後、HYCU画面の左側にあるApplicationsを選択すると、SQLインスタンスが表示されます。名前をクリックしてこのインスタンスを選択すると、画面の左下隅にウィンドウが表示されます。このウィンドウには、アプリケーションインスタンスに関する詳細が表示されます。

   .. figure:: images/4.png

#. 選択したSQLアプリケーションのDiscoveryアイコンが緑色でマークされていることに注意してください。これは、提供された資格情報には、SQLデータベースに対する必要なバックアップ管理者特権があることを意味します。そうでない場合は、権限を持つ別のOSユーザーを設定する必要があります。アカウント変更を行うには、 *Configuration*をクリックし、“Use VM credentials with access to the application”を有効化の上、資格情報を入力します。

   .. figure:: images/5.png

#. 他の2つの重要なオプションにも注意してください：

   .. figure:: images/6.png

#. 顧客が自分でトランザクションログの切り捨てを実行している場合、通常は15分間隔でログを切り捨てますが、HYCUはこれを認識し、ログを切り捨てないようにする必要があります。“Backup and truncate SQL transaction logs”トグルを無効にしてください。オプションが設定されている場合、HYCUは復元後にデータベースをリカバリモードのままにするため、手動でバックアップしたログをデータベースに適用できることに注意してください。

   .. figure:: images/7.png

   バックアップを実行すると、HYCUはSQLログバックアップを起動し、ログを一時的な場所にコピーします。これらのログはVMスナップショットの一部としてバックアップされ、最後に切り捨てられます。これらのログを別のディスクに保存し、そのパスを指定することをお勧めします。これにより、HYCUはログを保持しているディスクのみを復元できるため、より高速なポイントインタイムリカバリが可能になります。

#. 変更を加えずにこの画面を終了します。

#. 画面の右上隅にあるPoliciesを選択し、ポリシーをアプリケーションに割り当てます。この演習では、Goldポリシーを割り当てます。

   .. figure:: images/8.png

#. ポリシーが適用されると、バックアップが自動的に開始されます。

   .. figure:: images/9.png

   緑色のジョブ進捗状況バーをダブルクリックすると、Jobsページが表示され、ジョブの詳細が表示されます。アプリケーション整合性バックアップを実行するために、HYCUが実行しているすべての手順を確認できます。つまり、HYCUはデータベースを静止して整合性を確保し、VMのスナップショット（すべてのディスクを含む）を実行します。その後にデータベースのフリーズを解除します。変更されたブロックをCBT APIを使用してバックアップした後、ログは切り捨てられます（別途指定されている場合を除く）。

   .. figure:: images/10.png

#. バックアップ完了後、画面上部の検索ボックスのXをクリックしてフィルターをクリアします。

   .. figure:: images/11.png

#. Applicationsメニュー（画面左側）を選択し、SQLインスタンスを選択します。ジョブが完了し、バックアップステータスが緑色であることがわかります。緑色のステータスボタンの上にカーソルを置くと、バックアップがアプリケーション整合性を保ち、フルバックアップの実行にかかった時間がわかります。

   .. figure:: images/12.png

#. 画面右上中央にあるBackupを選択して、このSQLインスタンスの手動バックアップを実行します。フルバックアップを実行するかどうかを尋ねるウィンドウが表示します。増分を実行するため、フルバックアップオプションは選択しないでください。

   .. figure:: images/13.png

   増分バックアップは、はるかに高速であったことに注意してください。

SQLサーバーの復元
====================
完全なSQLサーバーVM、そのインスタンス、または単一のDBを復元するには、アプリケーションを選択してから、復元に使用するバックアップを選択します。この演習では、フルバックアップを選択して、Restore（画面の右中央）をクリックします。アプリケーションのバックアップでは、すべてのディスクのスナップショットを作成して仮想マシン全体をバックアップしているため、サーバー全体を復元できます。同じことは、仮想マシンのコンテキストからも実現できます。この場合、単一のファイルまたはフォルダの復元にも同じアプリケーションバックアップを使用できます。

#. この演習では、 *Restore databases*を選択して *Next*をクリックすることにより、SQLの詳細な復元に焦点を当てます。

   .. figure:: images/14.png

   .. figure:: images/15.png

#. インスタンス全体または個々のデータベースを復元するオプションがあることがわかります。インスタンス全体を選択すると、すべてのデータベースが復元されます。

   .. figure:: images/16.png

   HYCUは豊富な復元オプションを提供します。さまざまな使用例を見てみましょう。

#. 本番データをDev/Test SQLインスタンスに移動するには、 *Target Instance*ドロップダウンメニューを使用して、別のSQLインスタンスを選択できます。この演習では、別のSQLインスタンスはありませんが、下のスクリーンショットは、HYCUによって検出されたNutanix環境に複数のSQLインスタンスがある場合の実行方法を示しています。

   .. figure:: images/17.png

#. 多くの場合、データベースの破損や人為的エラーの場合、顧客は事故が発生する前の正確な時点に戻る必要があります。HYCUは、後続のリストアポイントからトランザクションログを復元し（一時的なログを別の場所の保存することの重要性を忘れないでください）、指定した時点までログを再生します。

   .. figure:: images/18.png

#. これを実現するには、個々のデータベースを選択し、 *目的の日時*を指定して *Next*をクリックします。

#. 次のメニューを使用すると、データベースを上書きせずに、別の名前（プレフィックス）と場所でデータベースを復元できます。これはテスト目的には役立ちますが、一時的な場所に復元されたデータベースから単一のテーブルを抽出する機能も提供します。

   .. figure:: images/19.png

#. 今回は単純に *Restore*をクリックして上書き復元を実行してみましょう。

まとめ
=======
これで標準的なSQLインスタンスのバックアップと復元の演習が完了しました。HYCUは、Always On SQLとSQLフェールオーバークラスターのバックアップや復元にも対応しています。
また、Microsoft Exchangeを含むバックアップや詳細な復元も可能です。DAG（データベースおよびメールボックスレベルの復元）およびOracle（テーブルスペースレベルの復元）です。
ADの場合はアプリケーション整合性のあるバックアップを実行できます。粒度の細かな復元には、ADのごみ箱を使用することをお勧めします。
AD VMの復元は、権限のない復元を使用して実行されます。AD VMが復元され、ドメインに再び参加すると、ドメインと同期します。権限のある復元を実行するには、HYCUサポートに連絡してください。
対応アプリケーションの最新リストについては、support.hycu.comで最新のHYCU compatibility matrix を確認してください。
